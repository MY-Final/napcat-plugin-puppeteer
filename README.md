# napcat-plugin-puppeteer

> [!WARNING]
> æ­¤æ’ä»¶ç›®å‰å¤„äºé¡¹ç›®åˆšå®Œæˆé˜¶æ®µï¼Œå¯èƒ½å­˜åœ¨è¾ƒå¤šé¢„æœŸå¤–çš„é—®é¢˜ã€‚å¦‚æœæ‚¨é‡åˆ° bugï¼Œæ¬¢è¿åœ¨ [Issues](https://github.com/AQiaoYo/napcat-plugin-puppeteer/issues) ä¸­è¿›è¡Œåé¦ˆã€‚
> **è¯·æ³¨æ„ï¼š** æäº¤åé¦ˆæ—¶è¯·ä¿æŒåŸºæœ¬çš„å°Šé‡ä¸ç¤¼è²Œï¼Œå¼€å‘è€…å¹¶ä¸æ¬ ä½ ä»»ä½•ä¸œè¥¿ï¼Œæ— ç¤¼çš„è¨€è®ºå°†è¢«ç›´æ¥å¿½è§†ã€‚

## ç›®å½•

- [napcat-plugin-puppeteer](#napcat-plugin-puppeteer)
  - [ç›®å½•](#ç›®å½•)
  - [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
  - [é¸£è°¢](#é¸£è°¢)
  - [åŠŸèƒ½äº®ç‚¹](#åŠŸèƒ½äº®ç‚¹)
  - [æ¶æ„ä¸æ ¸å¿ƒæ¨¡å—](#æ¶æ„ä¸æ ¸å¿ƒæ¨¡å—)
  - [è¿è¡Œå‰å‡†å¤‡](#è¿è¡Œå‰å‡†å¤‡)
  - [å®‰è£…ä¸éƒ¨ç½²](#å®‰è£…ä¸éƒ¨ç½²)
    - [é€šè¿‡ WebUI æ’ä»¶å¸‚åœºå®‰è£…ï¼ˆæ¨èï¼‰](#é€šè¿‡-webui-æ’ä»¶å¸‚åœºå®‰è£…æ¨è)
    - [æ‰‹åŠ¨å®‰è£…ï¼ˆå‘å¸ƒç‰ˆï¼‰](#æ‰‹åŠ¨å®‰è£…å‘å¸ƒç‰ˆ)
    - [ä»æºç æ„å»º](#ä»æºç æ„å»º)
  - [è‡ªåŠ¨å®‰è£… Chromeï¼ˆWebUI ä¸€é”®å®‰è£…ï¼‰](#è‡ªåŠ¨å®‰è£…-chromewebui-ä¸€é”®å®‰è£…)
    - [æ”¯æŒçš„å¹³å°](#æ”¯æŒçš„å¹³å°)
    - [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
    - [ä¸‹è½½æºé€‰æ‹©](#ä¸‹è½½æºé€‰æ‹©)
    - [Linux ç³»ç»Ÿä¾èµ–](#linux-ç³»ç»Ÿä¾èµ–)
  - [Docker éƒ¨ç½²è¿œç¨‹æµè§ˆå™¨ï¼ˆæ¨èï¼‰](#docker-éƒ¨ç½²è¿œç¨‹æµè§ˆå™¨æ¨è)
    - [ä¸ºä»€ä¹ˆæ¨èè¿™ç§æ–¹å¼ï¼Ÿ](#ä¸ºä»€ä¹ˆæ¨èè¿™ç§æ–¹å¼)
    - [æ–¹å¼ä¸€ï¼šä¸ NapCat Docker åŒç½‘ç»œéƒ¨ç½²ï¼ˆæ¨èï¼‰](#æ–¹å¼ä¸€ä¸-napcat-docker-åŒç½‘ç»œéƒ¨ç½²æ¨è)
      - [å¦‚æœå·²æœ‰è¿è¡Œä¸­çš„å®¹å™¨](#å¦‚æœå·²æœ‰è¿è¡Œä¸­çš„å®¹å™¨)
    - [æ–¹å¼äºŒï¼šç›´æ¥è¿è¡Œï¼ˆNapCat é Docker ç¯å¢ƒï¼‰](#æ–¹å¼äºŒç›´æ¥è¿è¡Œnapcat-é-docker-ç¯å¢ƒ)
    - [æ–¹å¼ä¸‰ï¼šä½¿ç”¨ Docker Compose](#æ–¹å¼ä¸‰ä½¿ç”¨-docker-compose)
    - [æ–¹å¼å››ï¼šä½¿ç”¨å…¶ä»–æµè§ˆå™¨é•œåƒ](#æ–¹å¼å››ä½¿ç”¨å…¶ä»–æµè§ˆå™¨é•œåƒ)
      - [zenika/alpine-chromeï¼ˆæ›´è½»é‡ï¼Œçº¦ 400MBï¼‰](#zenikaalpine-chromeæ›´è½»é‡çº¦-400mb)
    - [é…ç½®æ’ä»¶è¿æ¥è¿œç¨‹æµè§ˆå™¨](#é…ç½®æ’ä»¶è¿æ¥è¿œç¨‹æµè§ˆå™¨)
    - [éªŒè¯è¿æ¥](#éªŒè¯è¿æ¥)
    - [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
      - [Q: è¿æ¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ](#q-è¿æ¥å¤±è´¥æ€ä¹ˆåŠ)
      - [Q: ä¸ºä»€ä¹ˆå¡«äº†åœ°å€è¿˜æ˜¯æ˜¾ç¤ºã€Œæœ¬åœ°æ¨¡å¼ã€ï¼Ÿ](#q-ä¸ºä»€ä¹ˆå¡«äº†åœ°å€è¿˜æ˜¯æ˜¾ç¤ºæœ¬åœ°æ¨¡å¼)
      - [Q: ç«¯å£åº”è¯¥å¡« 3000 è¿˜æ˜¯ 3310ï¼Ÿ](#q-ç«¯å£åº”è¯¥å¡«-3000-è¿˜æ˜¯-3310)
      - [Q: å¦‚ä½•éªŒè¯ä¸¤ä¸ªå®¹å™¨åœ¨åŒä¸€ç½‘ç»œï¼Ÿ](#q-å¦‚ä½•éªŒè¯ä¸¤ä¸ªå®¹å™¨åœ¨åŒä¸€ç½‘ç»œ)
      - [Q: å¦‚ä½•æŸ¥çœ‹æµè§ˆå™¨æœåŠ¡æ—¥å¿—ï¼Ÿ](#q-å¦‚ä½•æŸ¥çœ‹æµè§ˆå™¨æœåŠ¡æ—¥å¿—)
      - [Q: å¦‚ä½•é™åˆ¶æµè§ˆå™¨èµ„æºä½¿ç”¨ï¼Ÿ](#q-å¦‚ä½•é™åˆ¶æµè§ˆå™¨èµ„æºä½¿ç”¨)
      - [Q: browserless/chrome æœ‰ Web ç®¡ç†ç•Œé¢å—ï¼Ÿ](#q-browserlesschrome-æœ‰-web-ç®¡ç†ç•Œé¢å—)
  - [NapCat Docker ç”¨æˆ·ï¼šæœ¬åœ°å®‰è£… Chrome å¹¶æŒä¹…åŒ–](#napcat-docker-ç”¨æˆ·æœ¬åœ°å®‰è£…-chrome-å¹¶æŒä¹…åŒ–)
    - [æ–¹æ¡ˆä¸€ï¼šæŒ‚è½½ Chrome å®‰è£…ç›®å½•ï¼ˆæ¨èï¼‰](#æ–¹æ¡ˆä¸€æŒ‚è½½-chrome-å®‰è£…ç›®å½•æ¨è)
    - [æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Docker Volume](#æ–¹æ¡ˆäºŒä½¿ç”¨-docker-volume)
    - [æ–¹æ¡ˆä¸‰ï¼šæ„å»ºè‡ªå®šä¹‰é•œåƒï¼ˆä¸€åŠ³æ°¸é€¸ï¼‰](#æ–¹æ¡ˆä¸‰æ„å»ºè‡ªå®šä¹‰é•œåƒä¸€åŠ³æ°¸é€¸)
    - [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
  - [è¿è¡Œæ—¶è¡Œä¸º](#è¿è¡Œæ—¶è¡Œä¸º)
  - [API å‚è€ƒ](#api-å‚è€ƒ)
    - [åŸºç¡€ä¿¡æ¯](#åŸºç¡€ä¿¡æ¯)
    - [æ ¸å¿ƒæ¥å£](#æ ¸å¿ƒæ¥å£)
    - [`/screenshot` è¯·æ±‚ä½“ï¼ˆPOSTï¼‰](#screenshot-è¯·æ±‚ä½“post)
    - [`/render` è¯·æ±‚ä½“ï¼ˆPOSTï¼‰](#render-è¯·æ±‚ä½“post)
    - [ç®¡ç†æ¥å£ï¼ˆéœ€è®¤è¯ï¼‰](#ç®¡ç†æ¥å£éœ€è®¤è¯)
  - [å“åº”ç»“æ„ä¸çŠ¶æ€ç ](#å“åº”ç»“æ„ä¸çŠ¶æ€ç )
  - [é…ç½®é¡¹](#é…ç½®é¡¹)
  - [WebUI æ§åˆ¶å°](#webui-æ§åˆ¶å°)
  - [æ’ä»¶å†…äºŒæ¬¡å¼€å‘](#æ’ä»¶å†…äºŒæ¬¡å¼€å‘)
  - [æœ¬åœ°å¼€å‘æŒ‡å—](#æœ¬åœ°å¼€å‘æŒ‡å—)
  - [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
  - [è®¸å¯è¯](#è®¸å¯è¯)

## é¡¹ç›®ç®€ä»‹

`napcat-plugin-puppeteer` æ˜¯ä¸€æ¬¾ä¸º NapCat æ‰“é€ çš„åå°æ¸²æŸ“æ’ä»¶ã€‚æ’ä»¶åŸºäº `puppeteer-core` æä¾› Chromium æˆªå›¾èƒ½åŠ›ï¼ŒSurfacing ä¸ºä¸¤ä¸ªå±‚é¢ï¼š

- **HTTP API**ï¼šå…¶å®ƒ NapCat æ’ä»¶æˆ–å¤–éƒ¨ç³»ç»Ÿå¯é€šè¿‡ NapCat æä¾›çš„ HTTP æœåŠ¡ç›´æ¥è°ƒç”¨ã€‚
- **WebUI æ§åˆ¶å°**ï¼šåœ¨ NapCat WebUI ä¸­æä¾›ç®¡ç†ç•Œé¢ï¼Œç”¨äºæµè§ˆå™¨ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ã€åœ¨çº¿è°ƒè¯•ä¸é…ç½®ã€‚

é¡¹ç›®ä½¿ç”¨ TypeScript + Vite æ„å»ºï¼Œäº§ç‰©ä½äº `dist/index.mjs`ï¼Œå¯ç›´æ¥æŠ•æ”¾åˆ° NapCat æ’ä»¶ç›®å½•ä½¿ç”¨ã€‚

## é¸£è°¢

æœ¬æ’ä»¶çš„å®ç°æ€è·¯å‚è€ƒäº† [karin-puppeteer](https://github.com/KarinJS/karin-puppeteer)

## åŠŸèƒ½äº®ç‚¹

- ï¿½ **å¤šæºè¾“å…¥**ï¼šæ”¯æŒç½‘é¡µ URLã€æœ¬åœ°æ–‡ä»¶ (`file://`)ã€åŸå§‹ HTML å­—ç¬¦ä¸²ã€‚
- ğŸ§© **æ¨¡æ¿æ¸²æŸ“**ï¼šå†…ç½® `{{key}}` å ä½ç¬¦æ›¿æ¢ï¼Œå¯å¿«é€Ÿç”ŸæˆåŠ¨æ€å†…å®¹ã€‚
- ï¿½ï¸ **æˆªå›¾ç­–ç•¥**ï¼šæ”¯æŒå•å…ƒç´ ã€å…¨é¡µé¢ä»¥åŠæŒ‰åƒç´ é«˜åº¦åˆ†é¡µè¾“å‡ºã€‚
- âš™ï¸ **å¼¹æ€§é…ç½®**ï¼šè§†å£å¤§å°ã€è®¾å¤‡åƒç´ æ¯”ã€ç­‰å¾…ç­–ç•¥ã€HTTP å¤´éƒ¨å‡å¯å®šåˆ¶ã€‚
- ï¿½ **å¹¶å‘æ§åˆ¶**ï¼šå†…å»ºé¡µé¢ä¿¡å·é‡ï¼ŒæŒ‰ç…§ `maxPages` é™åˆ¶åŒæ—¶æ¸²æŸ“æ•°é‡ï¼Œé¿å…æµè§ˆå™¨è¿‡è½½ã€‚
- ğŸ§  **çŠ¶æ€å¯è§‚æµ‹**ï¼šå®æ—¶æŸ¥è¯¢æµè§ˆå™¨çŠ¶æ€ã€æ€»æ¸²æŸ“æ¬¡æ•°ã€å¤±è´¥ç»Ÿè®¡ä¸è¿è¡Œæ—¶é•¿ã€‚
- ğŸŒ **ä¸€ä½“åŒ–ç®¡ç†**ï¼šWebUI é›†æˆçŠ¶æ€é¢æ¿ã€æ¸²æŸ“è°ƒè¯•ã€é…ç½®é¢æ¿ã€API æ–‡æ¡£ã€‚

## æ¶æ„ä¸æ ¸å¿ƒæ¨¡å—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ src/index.ts                               â”‚
â”‚ NapCat ç”Ÿå‘½å‘¨æœŸã€è·¯ç”±æ³¨å†Œã€å¯¹å¤–å¯¼å‡º           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ src/core/state.ts    â”‚ å…¨å±€çŠ¶æ€å•ä¾‹ã€é…ç½®è¯»å†™ â”‚
â”‚ src/config.ts        â”‚ é»˜è®¤é…ç½® + WebUI Schema â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ src/services/puppeteer-service.ts          â”‚
â”‚ æµè§ˆå™¨å¯åŠ¨ã€é¡µé¢è°ƒåº¦ã€æˆªå›¾æ¸²æŸ“æ ¸å¿ƒé€»è¾‘        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ src/webui/           â”‚ æ§åˆ¶å°å‰ç«¯èµ„æº         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- `src/index.ts`ï¼šå®ç° `plugin_init` ç­‰ NapCat ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œæ³¨å†Œ `/plugin/{id}/api`ï¼ˆæ— è®¤è¯ï¼‰ä¸ `/api/Plugin/ext/{id}`ï¼ˆéœ€è®¤è¯ï¼‰ä¸¤ç»„è·¯ç”±ï¼Œå¹¶æš´éœ² `screenshot`ã€`renderHtml` ç­‰å‡½æ•°ã€‚
- `src/core/state.ts`ï¼š`pluginState` å•ä¾‹è´Ÿè´£æ—¥å¿—ã€é…ç½®æ–‡ä»¶è¯»å†™ã€è¿è¡ŒçŠ¶æ€ç»Ÿè®¡ä»¥åŠ NapCat API è°ƒç”¨ä»£ç†ã€‚
- `src/services/puppeteer-service.ts`ï¼šå°è£…æµè§ˆå™¨å¯åŠ¨ã€å¹¶å‘é¡µé¢ç®¡ç†ã€æ¨¡æ¿æ¸²æŸ“ã€åˆ†é¡µæˆªå›¾ç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚
- `vite.config.ts`ï¼šé€šè¿‡ Vite æ‰“åŒ… TypeScriptï¼Œå†…è” `puppeteer-core` ä»¥ä¾¿æ’ä»¶åœ¨ç›®æ ‡ç¯å¢ƒç‹¬ç«‹è¿è¡Œã€‚

## è¿è¡Œå‰å‡†å¤‡

- å®‰è£… [NapCat](https://napneko.github.io/napcat/) å¹¶å¯ç”¨æ’ä»¶ç®¡ç†åŠŸèƒ½ã€‚
- æµè§ˆå™¨ç¯å¢ƒï¼ˆä»¥ä¸‹æ–¹å¼ä»»é€‰å…¶ä¸€ï¼‰ï¼š
  - **è‡ªåŠ¨å®‰è£…ï¼ˆæ¨èï¼‰**ï¼šæ’ä»¶æ”¯æŒåœ¨ WebUI ä¸­ä¸€é”®å®‰è£… Chrome for Testingï¼Œæ”¯æŒ Windowsã€macOSã€Linuxï¼ˆx64ï¼‰å¹³å°
  - **æ‰‹åŠ¨å®‰è£…**ï¼šç³»ç»Ÿéœ€å®‰è£…å¯æ‰§è¡Œçš„ Chromium å†…æ ¸æµè§ˆå™¨ï¼ˆChromeã€Edge æˆ– Chromiumï¼‰ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨æ£€æµ‹å¸¸è§è·¯å¾„
  - **è¿œç¨‹æµè§ˆå™¨**ï¼šä½¿ç”¨ [Docker éƒ¨ç½²è¿œç¨‹æµè§ˆå™¨](#docker-éƒ¨ç½²è¿œç¨‹æµè§ˆå™¨æ¨è)ï¼Œé€‚åˆ Docker ç¯å¢ƒæˆ–ä¸æƒ³æœ¬åœ°å®‰è£…æµè§ˆå™¨çš„ç”¨æˆ·
- å»ºè®®å®‰è£… `pnpm`ï¼Œæ–¹ä¾¿ä»æºç æ„å»ºã€‚

## å®‰è£…ä¸éƒ¨ç½²

### é€šè¿‡ WebUI æ’ä»¶å¸‚åœºå®‰è£…ï¼ˆæ¨èï¼‰

1. ç™»å½• NapCat WebUIã€‚
2. è¿›å…¥ã€Œæ’ä»¶å¸‚åœºã€ã€‚
3. æœç´¢ `napcat-plugin-puppeteer`ã€‚
4. ç‚¹å‡»ã€Œå®‰è£…ã€å¹¶ç­‰å¾…å®Œæˆã€‚

### æ‰‹åŠ¨å®‰è£…ï¼ˆå‘å¸ƒç‰ˆï¼‰

1. è®¿é—® [GitHub Releases](https://github.com/AQiaoYo/napcat-plugin-puppeteer/releases) ä¸‹è½½æœ€æ–°å‘å¸ƒåŒ…ã€‚
2. è§£å‹å¹¶å°†æ–‡ä»¶å¤¹æ”¾å…¥ NapCat æ’ä»¶ç›®å½•ï¼ˆé€šå¸¸ä¸º `%NAPCAT%/data/plugins/napcat-plugin-puppeteer`ï¼‰ã€‚
3. é‡å¯ NapCat æˆ–åœ¨ WebUI ä¸­é‡æ–°æ‰«ææ’ä»¶ã€‚

### ä»æºç æ„å»º

```powershell
pnpm install
pnpm run build
```

æ„å»ºæµç¨‹ä¼šï¼š

- ä½¿ç”¨ Vite å°† `src/index.ts` æ‰“åŒ…æˆ `dist/index.mjs`ã€‚
- è‡ªåŠ¨å°† `src/webui` å¤åˆ¶åˆ° `dist/webui`ã€‚
- ç²¾ç®€ `package.json` ååŒæ­¥åˆ° `dist/package.json`ï¼ˆç§»é™¤å¼€å‘ä¾èµ–ã€è„šæœ¬ï¼‰ã€‚

## è‡ªåŠ¨å®‰è£… Chromeï¼ˆWebUI ä¸€é”®å®‰è£…ï¼‰

æ’ä»¶æ”¯æŒåœ¨ WebUI ä¸­è‡ªåŠ¨ä¸‹è½½å®‰è£… Chrome for Testingï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®æµè§ˆå™¨è·¯å¾„ã€‚

### æ”¯æŒçš„å¹³å°

| å¹³å° | æ¶æ„ | æ”¯æŒçŠ¶æ€ |
|------|------|----------|
| Windows | x64 / x86 | âœ… å®Œå…¨æ”¯æŒ |
| macOS | Intel / Apple Silicon | âœ… å®Œå…¨æ”¯æŒ |
| Linux | x64 | âœ… å®Œå…¨æ”¯æŒ |
| Linux | ARM64 | âŒ æš‚ä¸æ”¯æŒï¼ˆå»ºè®®ä½¿ç”¨è¿œç¨‹æµè§ˆå™¨ï¼‰ |

### ä½¿ç”¨æ–¹æ³•

1. è¿›å…¥ **æ‰©å±•é¡µé¢** â†’ **Puppeteer æ¸²æŸ“æœåŠ¡** â†’ **æ§åˆ¶å°**
2. ç‚¹å‡»å·¦ä¾§ **è®¾ç½®**
3. åœ¨ **ç¯å¢ƒç®¡ç†** åŒºåŸŸï¼š
   - æŸ¥çœ‹ç³»ç»Ÿå·²å®‰è£…çš„æµè§ˆå™¨åˆ—è¡¨ï¼Œå¯ä¸€é”®é€‰æ‹©ä½¿ç”¨
   - å¦‚æœæ²¡æœ‰å¯ç”¨æµè§ˆå™¨ï¼Œç‚¹å‡» **ç«‹å³å®‰è£… Chrome** æŒ‰é’®
4. å®‰è£…è¿‡ç¨‹ä¼šæ˜¾ç¤ºè¿›åº¦æ¡ï¼Œå®Œæˆåè‡ªåŠ¨é…ç½®å¹¶å¯åŠ¨æµè§ˆå™¨

### ä¸‹è½½æºé€‰æ‹©

| ä¸‹è½½æº | è¯´æ˜ |
|--------|------|
| NPM é•œåƒï¼ˆæ¨èï¼‰ | å›½å†…ç”¨æˆ·æ¨èï¼Œé€Ÿåº¦å¿« |
| Google å®˜æ–¹æº | å›½å¤–ç”¨æˆ·æˆ–éœ€è¦æœ€æ–°ç‰ˆæœ¬æ—¶ä½¿ç”¨ |

### Linux ç³»ç»Ÿä¾èµ–

åœ¨ Linux ä¸Šå®‰è£… Chrome æ—¶ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨å®‰è£…æ‰€éœ€çš„ç³»ç»Ÿä¾èµ–ã€‚æ”¯æŒä»¥ä¸‹å‘è¡Œç‰ˆï¼š

- **Debian/Ubuntu ç³»åˆ—**ï¼šDebianã€Ubuntuã€Linux Mintã€Pop!_OSã€Elementary OS ç­‰
- **Fedora/RHEL ç³»åˆ—**ï¼šFedoraã€RHELã€CentOSã€Rocky Linuxã€AlmaLinux ç­‰
- **Arch Linux ç³»åˆ—**ï¼šArchã€Manjaroã€EndeavourOS ç­‰
- **openSUSE ç³»åˆ—**ï¼šopenSUSEã€SLES ç­‰
- **Alpine Linux**ï¼šè½»é‡çº§å®¹å™¨ç¯å¢ƒ

> âš ï¸ **æ³¨æ„**ï¼šè‡ªåŠ¨å®‰è£…ä¾èµ–éœ€è¦ root æƒé™ã€‚å¦‚æœæ²¡æœ‰æƒé™ï¼Œè¯·æ‰‹åŠ¨å®‰è£…ä¾èµ–æˆ–ä½¿ç”¨è¿œç¨‹æµè§ˆå™¨ã€‚

## Docker éƒ¨ç½²è¿œç¨‹æµè§ˆå™¨ï¼ˆæ¨èï¼‰

å¦‚æœä½ çš„ NapCat è¿è¡Œåœ¨ Docker å®¹å™¨ä¸­ï¼Œæˆ–è€…ä¸æƒ³åœ¨æœ¬æœºå®‰è£…æµè§ˆå™¨ï¼Œå¯ä»¥ä½¿ç”¨ Docker éƒ¨ç½²ä¸€ä¸ªç‹¬ç«‹çš„æµè§ˆå™¨æœåŠ¡ï¼Œç„¶åé€šè¿‡ WebSocket è¿æ¥ã€‚

### ä¸ºä»€ä¹ˆæ¨èè¿™ç§æ–¹å¼ï¼Ÿ

- âœ… **æ— éœ€åœ¨ NapCat å®¹å™¨ä¸­å®‰è£…æµè§ˆå™¨**ï¼šé¿å…é•œåƒè‡ƒè‚¿ã€ä¾èµ–å†²çª
- âœ… **èµ„æºéš”ç¦»**ï¼šæµè§ˆå™¨å´©æºƒä¸ä¼šå½±å“ NapCat ä¸»è¿›ç¨‹
- âœ… **æ˜“äºç»´æŠ¤**ï¼šå¯ç‹¬ç«‹é‡å¯ã€å‡çº§æµè§ˆå™¨æœåŠ¡
- âœ… **æ”¯æŒå¤šå®ä¾‹å…±äº«**ï¼šå¤šä¸ª NapCat å®ä¾‹å¯å…±ç”¨ä¸€ä¸ªæµè§ˆå™¨æœåŠ¡

### æ–¹å¼ä¸€ï¼šä¸ NapCat Docker åŒç½‘ç»œéƒ¨ç½²ï¼ˆæ¨èï¼‰

> ğŸ¯ **æ­¤æ–¹å¼ä¸“ä¸º NapCat Docker ç”¨æˆ·è®¾è®¡**ï¼Œæ˜¯æœ€æ¨èçš„éƒ¨ç½²æ–¹æ¡ˆã€‚

å¦‚æœä½ çš„ NapCat æ˜¯é€šè¿‡ Docker è¿è¡Œçš„ï¼Œ**å¼ºçƒˆå»ºè®®**å°†æµè§ˆå™¨å®¹å™¨åŠ å…¥åŒä¸€ç½‘ç»œï¼š

```bash
# 1. åˆ›å»ºå…±äº«ç½‘ç»œï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
docker network create napcat-net

# 2. å¯åŠ¨æµè§ˆå™¨å®¹å™¨å¹¶åŠ å…¥ç½‘ç»œ
docker run -d \
  --name chrome-browser \
  --network napcat-net \
  --restart unless-stopped \
  -e MAX_CONCURRENT_SESSIONS=10 \
  --shm-size=2g \
  browserless/chrome:latest

# 3. å°† NapCat å®¹å™¨ä¹ŸåŠ å…¥åŒä¸€ç½‘ç»œ
docker network connect napcat-net <ä½ çš„napcatå®¹å™¨å>
```

ç„¶ååœ¨æ’ä»¶ WebUI è®¾ç½®ä¸­å¡«å†™**è¿œç¨‹æµè§ˆå™¨åœ°å€**ï¼š

```text
ws://chrome-browser:3000
```

> âš ï¸ **é‡è¦ï¼šå…³äºç«¯å£å·çš„è¯´æ˜**
> 
> è¿™é‡Œä½¿ç”¨çš„æ˜¯ **å®¹å™¨å†…éƒ¨ç«¯å£ `3000`**ï¼Œè€Œä¸æ˜¯å®¿ä¸»æœºæ˜ å°„ç«¯å£ï¼
> 
> | åœºæ™¯ | ä½¿ç”¨çš„åœ°å€ | ç«¯å£è¯´æ˜ |
> |------|-----------|----------|
> | ä»**å®¿ä¸»æœº**è®¿é—® | `ws://127.0.0.1:3310` | ä½¿ç”¨æ˜ å°„åˆ°å®¿ä¸»æœºçš„ç«¯å£ |
> | ä»**å¦ä¸€ä¸ª Docker å®¹å™¨**è®¿é—®ï¼ˆåŒç½‘ç»œï¼‰ | `ws://chrome-browser:3000` | ä½¿ç”¨å®¹å™¨å†…éƒ¨ç«¯å£ |
> 
> **åŸç†**ï¼šDocker ç«¯å£æ˜ å°„ `-p 3310:3000` çš„å«ä¹‰æ˜¯ã€Œå®¿ä¸»æœºçš„ 3310 ç«¯å£ â†’ å®¹å™¨çš„ 3000 ç«¯å£ã€ã€‚
> å½“ä¸¤ä¸ªå®¹å™¨åœ¨åŒä¸€ Docker ç½‘ç»œä¸­æ—¶ï¼Œå®ƒä»¬ç›´æ¥é€šè¿‡å®¹å™¨å†…éƒ¨ç½‘ç»œé€šä¿¡ï¼Œä¸ç»è¿‡å®¿ä¸»æœºï¼Œæ‰€ä»¥è¦ä½¿ç”¨å®¹å™¨å†…éƒ¨ç«¯å£ã€‚

#### å¦‚æœå·²æœ‰è¿è¡Œä¸­çš„å®¹å™¨

å¦‚æœä½ çš„ NapCat å’Œæµè§ˆå™¨å®¹å™¨å·²ç»åœ¨è¿è¡Œï¼Œå¯ä»¥ç›´æ¥å°†å®ƒä»¬åŠ å…¥åŒä¸€ç½‘ç»œï¼š

```bash
# åˆ›å»ºç½‘ç»œ
docker network create napcat-net

# å°†ä¸¤ä¸ªå®¹å™¨éƒ½è¿æ¥åˆ°è¿™ä¸ªç½‘ç»œ
docker network connect napcat-net chrome-browser
docker network connect napcat-net napcat  # æ›¿æ¢ä¸ºä½ çš„ NapCat å®¹å™¨å

# éªŒè¯ç½‘ç»œè¿æ¥
docker network inspect napcat-net
```

ç„¶ååœ¨æ’ä»¶é…ç½®ä¸­å¡«å†™ï¼š`ws://chrome-browser:3000`

### æ–¹å¼äºŒï¼šç›´æ¥è¿è¡Œï¼ˆNapCat é Docker ç¯å¢ƒï¼‰

> ğŸ’¡ **æ­¤æ–¹å¼é€‚ç”¨äº NapCat ç›´æ¥è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šï¼ˆé Dockerï¼‰çš„æƒ…å†µ**

```bash
docker run -d \
  --name chrome-browser \
  --restart unless-stopped \
  -p 3310:3000 \
  -e MAX_CONCURRENT_SESSIONS=10 \
  -e CONNECTION_TIMEOUT=60000 \
  --shm-size=2g \
  browserless/chrome:latest
```

å¯åŠ¨åï¼Œåœ¨æ’ä»¶ WebUI è®¾ç½®ä¸­å¡«å†™**è¿œç¨‹æµè§ˆå™¨åœ°å€**ï¼š

```text
ws://<ä½ çš„æœåŠ¡å™¨IP>:3310
```

**ç¤ºä¾‹**ï¼š
- æœ¬æœºè®¿é—®ï¼š`ws://127.0.0.1:3310`
- å±€åŸŸç½‘è®¿é—®ï¼š`ws://192.168.1.100:3310`ï¼ˆæ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨å®é™… IPï¼‰

> âš ï¸ **æ³¨æ„**ï¼š
> - `127.0.0.1` ä»…åœ¨ NapCat ä¸æµè§ˆå™¨è¿è¡Œåœ¨**åŒä¸€å°æœºå™¨**ä¸Šæ—¶æœ‰æ•ˆ
> - å¦‚æœ NapCat è¿è¡Œåœ¨å…¶ä»–æœºå™¨ä¸Šï¼Œéœ€è¦å¡«å†™æµè§ˆå™¨æ‰€åœ¨æœåŠ¡å™¨çš„å®é™… IP åœ°å€
> - ç«¯å£ `3310` å¯ä»¥æ ¹æ®ä½ çš„ç¯å¢ƒè‡ªè¡Œè°ƒæ•´ï¼Œé¿å…ä¸å…¶ä»–æœåŠ¡å†²çª

### æ–¹å¼ä¸‰ï¼šä½¿ç”¨ Docker Compose

åˆ›å»º `docker-compose.yml` æ–‡ä»¶ï¼š

```yaml
version: '3.8'

services:
  chrome:
    image: browserless/chrome:latest
    container_name: chrome-browser
    restart: unless-stopped
    ports:
      - "3310:3000"    # å¯è‡ªè¡Œä¿®æ”¹ç«¯å£ï¼Œæ ¼å¼ä¸º å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£
    environment:
      - MAX_CONCURRENT_SESSIONS=10      # æœ€å¤§å¹¶å‘ä¼šè¯æ•°
      - CONNECTION_TIMEOUT=60000        # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      - PREBOOT_CHROME=true             # é¢„å¯åŠ¨æµè§ˆå™¨ï¼ŒåŠ å¿«é¦–æ¬¡è¿æ¥
      - KEEP_ALIVE=true                 # ä¿æŒè¿æ¥æ´»è·ƒ
    shm_size: '2gb'    # å…±äº«å†…å­˜å¤§å°ï¼Œå»ºè®®è‡³å°‘ 1GB
    # å¯é€‰ï¼šé™åˆ¶èµ„æºä½¿ç”¨
    # deploy:
    #   resources:
    #     limits:
    #       memory: 2G
    #       cpus: '2'
```

å¯åŠ¨æœåŠ¡ï¼š

```bash
docker-compose up -d
```

### æ–¹å¼å››ï¼šä½¿ç”¨å…¶ä»–æµè§ˆå™¨é•œåƒ

é™¤äº† `browserless/chrome`ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–é•œåƒï¼š

#### zenika/alpine-chromeï¼ˆæ›´è½»é‡ï¼Œçº¦ 400MBï¼‰

```bash
docker run -d \
  --name chrome-browser \
  --restart unless-stopped \
  -p 3310:9222 \
  --shm-size=2g \
  zenika/alpine-chrome:latest \
  --no-sandbox \
  --disable-gpu \
  --disable-dev-shm-usage \
  --remote-debugging-address=0.0.0.0 \
  --remote-debugging-port=9222
```

é…ç½®åœ°å€ï¼ˆéœ€è¦å…ˆè·å– WebSocket åœ°å€ï¼‰ï¼š

```bash
# è·å– WebSocket åœ°å€
curl http://127.0.0.1:3310/json/version
# è¿”å›çš„ webSocketDebuggerUrl å³ä¸ºè¿æ¥åœ°å€
```

### é…ç½®æ’ä»¶è¿æ¥è¿œç¨‹æµè§ˆå™¨

éƒ¨ç½²å¥½æµè§ˆå™¨æœåŠ¡åï¼Œåœ¨ NapCat WebUI ä¸­é…ç½®æ’ä»¶ï¼š

1. è¿›å…¥ **æ’ä»¶ç®¡ç†** â†’ **Puppeteer æ¸²æŸ“æœåŠ¡** â†’ **æ§åˆ¶å°**
2. ç‚¹å‡»å·¦ä¾§ **è®¾ç½®**
3. åœ¨ **è¿œç¨‹æµè§ˆå™¨åœ°å€ (Docker)** ä¸­å¡«å…¥ WebSocket åœ°å€ï¼Œä¾‹å¦‚ï¼š
   - NapCat Docker ç”¨æˆ·ï¼š`ws://chrome-browser:3000`
   - NapCat é Docker ç”¨æˆ·ï¼š`ws://127.0.0.1:3310`
4. ä¿å­˜é…ç½®åï¼Œç‚¹å‡» **é‡å¯æµè§ˆå™¨** ä½¿é…ç½®ç”Ÿæ•ˆ

### éªŒè¯è¿æ¥

é…ç½®å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ï¼š

1. åœ¨ WebUI æ§åˆ¶å°çš„ **æ¦‚è§ˆ** é¡µé¢æŸ¥çœ‹æµè§ˆå™¨çŠ¶æ€
2. è¿æ¥æ¨¡å¼åº”æ˜¾ç¤ºä¸º **ğŸŒ è¿œç¨‹è¿æ¥**
3. åœ¨ **æµ‹è¯•** é¡µé¢è¿›è¡Œä¸€æ¬¡æˆªå›¾æµ‹è¯•

### å¸¸è§é—®é¢˜

#### Q: è¿æ¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

1. ç¡®è®¤æµè§ˆå™¨å®¹å™¨æ­£åœ¨è¿è¡Œï¼š`docker ps | grep chrome`
2. æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®æ˜ å°„ï¼š`docker port chrome-browser`
3. æµ‹è¯• WebSocket ç«¯å£æ˜¯å¦å¯è¾¾ï¼š`curl http://127.0.0.1:3310/json/version`
4. å¦‚æœ NapCat åœ¨ Docker ä¸­ï¼Œç¡®ä¿ä¸¤ä¸ªå®¹å™¨åœ¨åŒä¸€ç½‘ç»œ

#### Q: ä¸ºä»€ä¹ˆå¡«äº†åœ°å€è¿˜æ˜¯æ˜¾ç¤ºã€Œæœ¬åœ°æ¨¡å¼ã€ï¼Ÿ

æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç¡®ä¿åœ°å€ä»¥ `ws://` å¼€å¤´
2. ä¿å­˜é…ç½®åéœ€è¦**é‡å¯æµè§ˆå™¨**æ‰èƒ½ç”Ÿæ•ˆ
3. æ£€æŸ¥ NapCat æ—¥å¿—æ˜¯å¦æœ‰é…ç½®è¯»å–é”™è¯¯

#### Q: ç«¯å£åº”è¯¥å¡« 3000 è¿˜æ˜¯ 3310ï¼Ÿ

è¿™å–å†³äºä½ çš„éƒ¨ç½²æ–¹å¼ï¼š

| NapCat è¿è¡Œç¯å¢ƒ | æµè§ˆå™¨åœ°å€ | ç«¯å£ |
|----------------|-----------|------|
| å®¿ä¸»æœºï¼ˆé Dockerï¼‰ | `ws://127.0.0.1:3310` | å®¿ä¸»æœºæ˜ å°„ç«¯å£ |
| Docker å®¹å™¨ï¼ˆåŒç½‘ç»œï¼‰ | `ws://chrome-browser:3000` | å®¹å™¨å†…éƒ¨ç«¯å£ |

**åŸç†**ï¼š`-p 3310:3000` è¡¨ç¤ºã€Œå®¿ä¸»æœº 3310 â†’ å®¹å™¨ 3000ã€ã€‚åŒä¸€ Docker ç½‘ç»œå†…çš„å®¹å™¨ç›´æ¥é€šä¿¡ï¼Œä½¿ç”¨å†…éƒ¨ç«¯å£ï¼›ä»å®¿ä¸»æœºè®¿é—®åˆ™ä½¿ç”¨æ˜ å°„ç«¯å£ã€‚

#### Q: å¦‚ä½•éªŒè¯ä¸¤ä¸ªå®¹å™¨åœ¨åŒä¸€ç½‘ç»œï¼Ÿ

```bash
# æŸ¥çœ‹ç½‘ç»œä¸­çš„å®¹å™¨
docker network inspect napcat-net

# æˆ–è€…è¿›å…¥ NapCat å®¹å™¨æµ‹è¯•è¿é€šæ€§
docker exec -it napcat ping chrome-browser
docker exec -it napcat curl http://chrome-browser:3000/json/version
```

#### Q: å¦‚ä½•æŸ¥çœ‹æµè§ˆå™¨æœåŠ¡æ—¥å¿—ï¼Ÿ

```bash
docker logs -f chrome-browser
```

#### Q: å¦‚ä½•é™åˆ¶æµè§ˆå™¨èµ„æºä½¿ç”¨ï¼Ÿ

```bash
docker run -d \
  --name chrome-browser \
  --memory=2g \
  --cpus=2 \
  # ... å…¶ä»–å‚æ•°
```

#### Q: browserless/chrome æœ‰ Web ç®¡ç†ç•Œé¢å—ï¼Ÿ

æœ‰çš„ï¼è®¿é—® `http://127.0.0.1:3310` å¯ä»¥çœ‹åˆ°è°ƒè¯•ç•Œé¢ï¼ŒåŒ…æ‹¬ï¼š
- å½“å‰æ´»è·ƒä¼šè¯
- æ€§èƒ½æŒ‡æ ‡
- è°ƒè¯•å·¥å…·

## NapCat Docker ç”¨æˆ·ï¼šæœ¬åœ°å®‰è£… Chrome å¹¶æŒä¹…åŒ–

å¦‚æœä½ ä¸æƒ³ä½¿ç”¨è¿œç¨‹æµè§ˆå™¨ï¼Œè€Œæ˜¯å¸Œæœ›åœ¨ NapCat Docker å®¹å™¨å†…å®‰è£… Chromeï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åœ¨æ›´æ–°é•œåƒæ—¶ä¿ç•™å·²å®‰è£…çš„ Chromeã€‚

### æ–¹æ¡ˆä¸€ï¼šæŒ‚è½½ Chrome å®‰è£…ç›®å½•ï¼ˆæ¨èï¼‰

Chrome é»˜è®¤å®‰è£…åœ¨ `/app/.cache/puppeteer/chrome` ç›®å½•ï¼ˆå®¹å™¨å†…è·¯å¾„ï¼‰ï¼Œå°†æ­¤ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºå³å¯æŒä¹…åŒ–ï¼š

```bash
# åˆ›å»ºå®¿ä¸»æœºç›®å½•
mkdir -p /path/to/napcat-data/chrome-cache

# å¯åŠ¨å®¹å™¨æ—¶æŒ‚è½½
docker run -d \
  --name napcat \
  -v /path/to/napcat-data:/app/napcat/data \
  -v /path/to/napcat-data/chrome-cache:/app/.cache/puppeteer \
  # ... å…¶ä»–å‚æ•°
  mlikiowa/napcat-docker:latest
```

**Docker Compose é…ç½®**ï¼š

```yaml
services:
  napcat:
    image: mlikiowa/napcat-docker:latest
    volumes:
      - ./napcat-data:/app/napcat/data
      - ./napcat-data/chrome-cache:/app/.cache/puppeteer  # Chrome æŒä¹…åŒ–
    # ... å…¶ä»–é…ç½®
```

è¿™æ ·å³ä½¿æ›´æ–° NapCat é•œåƒï¼ŒChrome ä¹Ÿä¼šä¿ç•™åœ¨å®¿ä¸»æœºä¸Šã€‚

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Docker Volume

```bash
# åˆ›å»ºå‘½åå·
docker volume create napcat-chrome-cache

# å¯åŠ¨å®¹å™¨æ—¶ä½¿ç”¨
docker run -d \
  --name napcat \
  -v napcat-data:/app/napcat/data \
  -v napcat-chrome-cache:/app/.cache/puppeteer \
  # ... å…¶ä»–å‚æ•°
  mlikiowa/napcat-docker:latest
```

### æ–¹æ¡ˆä¸‰ï¼šæ„å»ºè‡ªå®šä¹‰é•œåƒï¼ˆä¸€åŠ³æ°¸é€¸ï¼‰

å¦‚æœä½ å¸Œæœ›é•œåƒè‡ªå¸¦ Chromeï¼Œå¯ä»¥åŸºäº NapCat é•œåƒæ„å»ºï¼š

```dockerfile
FROM mlikiowa/napcat-docker:latest

# å®‰è£… Chrome ä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    fonts-liberation \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libatspi2.0-0 \
    libcairo2 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libexpat1 \
    libgbm1 \
    libglib2.0-0 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libpango-1.0-0 \
    libx11-6 \
    libxcb1 \
    libxcomposite1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxkbcommon0 \
    libxrandr2 \
    wget \
    xdg-utils \
    fonts-noto-cjk \
    fonts-wqy-zenhei \
    && rm -rf /var/lib/apt/lists/*

# ä¸‹è½½ Chrome for Testingï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥è®©æ’ä»¶è‡ªåŠ¨å®‰è£…ï¼‰
# RUN mkdir -p /root/.cache/puppeteer && \
#     wget -q -O /tmp/chrome.zip "https://cdn.npmmirror.com/binaries/chrome-for-testing/131.0.6778.204/linux64/chrome-linux64.zip" && \
#     unzip /tmp/chrome.zip -d /root/.cache/puppeteer/chrome && \
#     rm /tmp/chrome.zip
```

æ„å»ºå¹¶ä½¿ç”¨ï¼š

```bash
docker build -t napcat-with-chrome .
docker run -d --name napcat napcat-with-chrome
```

### æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡å®‰è£…**ï¼šæŒ‚è½½ç›®å½•åï¼Œé¦–æ¬¡ä»éœ€åœ¨ WebUI ä¸­ç‚¹å‡»ã€Œå®‰è£… Chromeã€
2. **æƒé™é—®é¢˜**ï¼šç¡®ä¿æŒ‚è½½ç›®å½•çš„æƒé™æ­£ç¡®ï¼Œå®¹å™¨å†…ç”¨æˆ·å¯è¯»å†™
3. **ç£ç›˜ç©ºé—´**ï¼šChrome for Testing çº¦éœ€ 400MB ç£ç›˜ç©ºé—´
4. **æ¨èæ–¹æ¡ˆ**ï¼šå¯¹äº Docker ç”¨æˆ·ï¼Œæˆ‘ä»¬ä»ç„¶**æ›´æ¨èä½¿ç”¨è¿œç¨‹æµè§ˆå™¨æ–¹æ¡ˆ**ï¼Œå› ä¸ºï¼š
   - èµ„æºéš”ç¦»æ›´å¥½
   - ä¸å— NapCat å®¹å™¨æ›´æ–°å½±å“
   - å¯å¤šå®ä¾‹å…±äº«

## è¿è¡Œæ—¶è¡Œä¸º

- **ç”Ÿå‘½å‘¨æœŸ**ï¼š`plugin_init` è¯»å–é…ç½®ã€å°è¯•å¯åŠ¨æµè§ˆå™¨ã€æ³¨å†Œè·¯ç”±ï¼›`plugin_cleanup` è´Ÿè´£å…³é—­æµè§ˆå™¨ã€‚
- **HTTP è·¯å¾„**ï¼š
  - æ— è®¤è¯ï¼š`/plugin/napcat-plugin-puppeteer/api/*`ï¼Œç”¨äºæ’ä»¶é—´è°ƒç”¨ã€‚
  - éœ€è®¤è¯ï¼š`/api/Plugin/ext/napcat-plugin-puppeteer/*`ï¼Œç”¨äº WebUI ç®¡ç†æ“ä½œã€‚
- **æµè§ˆå™¨è°ƒåº¦**ï¼š`puppeteer-service` ä»¥ä¿¡å·é‡æ–¹å¼é™åˆ¶å¹¶å‘é¡µé¢æ•°é‡ï¼›æ¯æ¬¡ä»»åŠ¡éƒ½ä¼šè°ƒç”¨ `acquirePage â†’ screenshot â†’ releasePage` æµç¨‹ã€‚
- **é»˜è®¤è§†å£**ï¼šç”± `browser.defaultViewportWidth/Height/deviceScaleFactor` æ§åˆ¶ï¼Œè°ƒç”¨æ—¶å¯é€šè¿‡è¯·æ±‚è¦†ç›–ã€‚
- **ç»Ÿè®¡ä¿¡æ¯**ï¼š`stats.totalRenders` ä¸ `stats.failedRenders` ä¼šé€šè¿‡ `/status`ã€`/browser/status` å¯¹å¤–æš´éœ²ã€‚

## API å‚è€ƒ

### åŸºç¡€ä¿¡æ¯

| åˆ†ç»„ | åŸºç¡€è·¯å¾„ | æ˜¯å¦éœ€è¦è®¤è¯ | è¯´æ˜ |
| ---- | -------- | ------------ | ---- |
| å…¬å…± API | `/plugin/napcat-plugin-puppeteer/api` | å¦ | æ’ä»¶é—´è°ƒç”¨ã€æ¸²æŸ“æœåŠ¡å…¥å£ |
| ç®¡ç† API | `/api/Plugin/ext/napcat-plugin-puppeteer` | æ˜¯ | WebUI ä½¿ç”¨ï¼Œéœ€æºå¸¦ NapCat token |

### æ ¸å¿ƒæ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
| ---- | ---- | ---- |
| `GET` | `/status` | æŸ¥è¯¢æ’ä»¶è¿è¡ŒçŠ¶æ€ã€æµè§ˆå™¨ç»Ÿè®¡ |
| `GET` | `/browser/status` | æŸ¥è¯¢æµè§ˆå™¨è¿æ¥ä¿¡æ¯ã€ç‰ˆæœ¬ã€ç´¯è®¡æ¸²æŸ“æ•° |
| `GET` | `/screenshot` | å¿«é€Ÿ URL æˆªå›¾ï¼›æ”¯æŒ `raw=true` ç›´æ¥è¿”å›å›¾ç‰‡æµ |
| `POST` | `/screenshot` | é€šç”¨æˆªå›¾å…¥å£ï¼Œæ”¯æŒ URL/HTML/æ–‡ä»¶ã€åˆ†é¡µã€å¤šç§ç¼–ç  |
| `POST` | `/render` | HTML æ¨¡æ¿æ¸²æŸ“å¹¶æˆªå›¾ï¼ˆ`file` æˆ– `html` äºŒé€‰ä¸€ï¼‰ |

### `/screenshot` è¯·æ±‚ä½“ï¼ˆPOSTï¼‰

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
| ---- | ---- | ---- | ---- |
| `file` | `string` | - | å¿…å¡«ï¼ŒURL / HTML / file:// |
| `file_type` | `'auto' \| 'htmlString'` | `auto` | å¼ºåˆ¶è§£é‡Šè¾“å…¥ç±»å‹ |
| `data` | `Record<string, any>` | - | æ¨¡æ¿å˜é‡ï¼ˆä»… HTML æ¨¡å¼ï¼‰ |
| `selector` | `string` | `body` | é¡µå†…ç›®æ ‡é€‰æ‹©å™¨ |
| `encoding` | `'base64' \| 'binary'` | `base64` | è¿”å›ç¼–ç  |
| `type` | `'png' \| 'jpeg' \| 'webp'` | `png` | å›¾ç‰‡æ ¼å¼ |
| `quality` | `number` | - | 1-100ï¼Œä»…å¯¹ `jpeg/webp` ç”Ÿæ•ˆ |
| `fullPage` | `boolean` | `false` | æ˜¯å¦æˆªå–æ•´é¡µ |
| `omitBackground` | `boolean` | `false` | æ˜¯å¦ç§»é™¤èƒŒæ™¯ï¼ˆé€æ˜ï¼‰ |
| `multiPage` | `boolean \| number` | `false` | åˆ†é¡µé«˜åº¦ï¼›`true` ç­‰åŒ 2000px |
| `setViewport` | `{ width,height,deviceScaleFactor }` | - | è¦†ç›–é»˜è®¤è§†å£ |
| `pageGotoParams` | `{ waitUntil, timeout }` | `{ waitUntil:'networkidle0' }` | é¡µé¢åŠ è½½ç­–ç•¥ |
| `waitForSelector` | `string` | - | ç­‰å¾…å…ƒç´ å‡ºç°åæˆªå›¾ |
| `waitForTimeout` | `number` | - | é¢å¤–ç­‰å¾…æ¯«ç§’æ•° |
| `headers` | `Record<string,string>` | - | è¯·æ±‚å¤´ï¼ˆä»… URL æ¨¡å¼ï¼‰ |

æˆåŠŸæ—¶è¿”å› `{ code:0, data, time }`ã€‚å½“ `encoding=base64` ä¸” `multiPage=true` æ—¶ `data` ä¸º Base64 æ•°ç»„ã€‚

### `/render` è¯·æ±‚ä½“ï¼ˆPOSTï¼‰

æ¥å—å­—æ®µä¸ `/screenshot` å¤§ä½“ä¸€è‡´ï¼Œé¢å¤–æ”¯æŒï¼š

- `html`ï¼šç›´æ¥ä¼ å…¥çš„ HTML å­—ç¬¦ä¸²ï¼›
- `file`ï¼šå½“éœ€åŠ è½½æœ¬åœ°æ–‡ä»¶æˆ–å¤–éƒ¨é“¾æ¥æ—¶ä½¿ç”¨ï¼›
- å¦‚æœåŒæ—¶ä¼ å…¥ `html` å’Œ `file`ï¼Œä¼˜å…ˆä½¿ç”¨ `html`ã€‚

### ç®¡ç†æ¥å£ï¼ˆéœ€è®¤è¯ï¼‰

| æ–¹æ³• | è·¯å¾„ | ç”¨é€” |
| ---- | ---- | ---- |
| `GET` | `/config` | è¯»å–å½“å‰è¿è¡Œé…ç½® |
| `POST` | `/config` | åˆå¹¶å¹¶ä¿å­˜é…ç½®ï¼ˆè‡ªåŠ¨å†™å…¥ç£ç›˜ï¼‰ |
| `POST` | `/browser/start` | å¯åŠ¨æµè§ˆå™¨å®ä¾‹ |
| `POST` | `/browser/stop` | å…³é—­æµè§ˆå™¨å®ä¾‹ |
| `POST` | `/browser/restart` | é‡å¯æµè§ˆå™¨å®ä¾‹ |

## å“åº”ç»“æ„ä¸çŠ¶æ€ç 

æ‰€æœ‰æ¥å£éµå¾ªç»Ÿä¸€ç»“æ„ï¼š

```json
{
  "code": 0,
  "data": {},
  "message": "å¯é€‰çš„é”™è¯¯æè¿°",
  "time": 123
}
```

| code | è¯´æ˜ |
| ---- | ---- |
| `0` | æˆåŠŸ |
| `-1` | æœªå®šä¹‰å¼‚å¸¸ã€Puppeteer å†…éƒ¨é”™è¯¯ |
| `400` | è¯·æ±‚å‚æ•°ç¼ºå¤±æˆ–ä¸åˆæ³• |
| `500` | æµè§ˆå™¨æ¸²æŸ“å¤±è´¥ã€é¡µé¢è¶…æ—¶ç­‰ |

## é…ç½®é¡¹

æ’ä»¶é…ç½®ä¿å­˜åœ¨ NapCat åˆ†é…çš„ `config.json`ï¼Œé»˜è®¤å€¼è§ `src/config.ts`ã€‚

| é”® | è¯´æ˜ | é»˜è®¤å€¼ |
| --- | --- | --- |
| `enabled` | æ˜¯å¦å¯ç”¨æ¸²æŸ“æœåŠ¡ | `true` |
| `debug` | æ˜¯å¦è¾“å‡ºè°ƒè¯•æ—¥å¿—ï¼ˆä¼šåœ¨ log ä¸­æ‰“å°å‚æ•°ã€ç”¨æ—¶ï¼‰ | `false` |
| `browser.executablePath` | æŒ‡å®šæµè§ˆå™¨è·¯å¾„ï¼Œç•™ç©ºæ—¶è‡ªåŠ¨æ£€æµ‹ | `""` |
| `browser.browserWSEndpoint` | è¿œç¨‹æµè§ˆå™¨ WebSocket åœ°å€ï¼ˆDocker æ¨¡å¼ï¼‰ | `""` |
| `browser.headless` | æ˜¯å¦ä½¿ç”¨æ— å¤´æ¨¡å¼ | `true` |
| `browser.args` | æµè§ˆå™¨å¯åŠ¨å‚æ•°æ•°ç»„ | é¢„ç½®ä¸€ç»„æ— å¤´ç¯å¢ƒå‹å¥½å‚æ•° |
| `browser.maxPages` | å¹¶å‘é¡µé¢ä¸Šé™ | `5` |
| `browser.timeout` | é¡µé¢å¯¼èˆªä¸ç­‰å¾…é»˜è®¤è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ | `30000` |
| `browser.defaultViewportWidth` | é»˜è®¤è§†å£å®½åº¦ | `1280` |
| `browser.defaultViewportHeight` | é»˜è®¤è§†å£é«˜åº¦ | `800` |
| `browser.deviceScaleFactor` | é»˜è®¤åƒç´ å¯†åº¦ | `2` |

åœ¨ WebUI ä¸­æ›´æ”¹é…ç½®ä¼šè‡ªåŠ¨è°ƒç”¨ `plugin_on_config_change` ä¿å­˜ï¼›ä¹Ÿå¯é€šè¿‡ç®¡ç† API å†™å…¥æ•´å—é…ç½®ã€‚

## WebUI æ§åˆ¶å°

è®¿é—® NapCat WebUI â†’ æ’ä»¶ç®¡ç† â†’ ã€ŒPuppeteer æ¸²æŸ“æœåŠ¡ã€ï¼Œå³å¯ä½¿ç”¨å†…ç½®æ§åˆ¶å°ï¼ˆ`src/webui/dashboard.html`ï¼‰ï¼š

- **æ¦‚è§ˆ**ï¼šå±•ç¤ºæ’ä»¶è¿è¡Œæ—¶é—´ã€æµè§ˆå™¨çŠ¶æ€ã€æ¸²æŸ“ç»Ÿè®¡ã€‚
- **æµè§ˆå™¨æ§åˆ¶**ï¼šä¸€é”®å¯åŠ¨/åœæ­¢/é‡å¯æµè§ˆå™¨å®ä¾‹ã€‚
- **æ¸²æŸ“è°ƒè¯•**ï¼šå¯åœ¨çº¿ç¼–è¾‘ HTML æ¨¡æ¿å¹¶ç«‹å³æŸ¥çœ‹è¾“å‡ºå›¾ç‰‡ã€‚
- **API æ–‡æ¡£**ï¼šå¿«é€ŸæŸ¥çœ‹è¯·æ±‚ç¤ºä¾‹ã€å­—æ®µè¯´æ˜ã€‚

æ§åˆ¶å°é™æ€èµ„æºåœ¨æ’ä»¶åŠ è½½æ—¶æŒ‚è½½è‡³ `/plugin/{pluginId}/page/puppeteer-dashboard`ã€‚

## æ’ä»¶å†…äºŒæ¬¡å¼€å‘

é™¤äº† HTTP è°ƒç”¨ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ NapCat æ’ä»¶ä»£ç ä¸­ç›´æ¥å¼•å…¥æœ¬æ’ä»¶å¯¼å‡ºçš„å‡½æ•°ï¼ˆéœ€è¦ NapCat æ”¯æŒæ’ä»¶ä¾èµ–åŠ è½½ï¼‰ï¼š

```typescript
import { renderHtml, screenshotUrl } from 'napcat-plugin-puppeteer';

const image = await renderHtml('<h1>{{msg}}</h1>', {
  data: { msg: 'Hello NapCat' },
  selector: 'h1',
});

if (image.status) {
  await ctx.sendGroupMsg(event.group_id, [
    { type: 'image', data: { file: `base64://${image.data}` } },
  ]);
}
```

è‹¥è¿è¡Œç¯å¢ƒæ— æ³•ç›´æ¥å¼•ç”¨æ¨¡å—ï¼Œä»å¯é€šè¿‡ HTTP æ¥å£è°ƒç”¨ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```typescript
const res = await fetch('http://localhost:6099/plugin/napcat-plugin-puppeteer/api/render', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    html: '<div style="padding:24px"><h2>{{title}}</h2></div>',
    data: { title: 'NapCat æ¬¢è¿ä½ ' },
    encoding: 'base64',
  }),
});

const result = await res.json();
if (result.code === 0) {
  // result.data å³ Base64 å­—ç¬¦ä¸²ï¼Œå¯ç›´æ¥ç»„è£… CQ ç æˆ– OneBot segment
}
```

## æœ¬åœ°å¼€å‘æŒ‡å—

- **ä¾èµ–ç®¡ç†**ï¼šä½¿ç”¨ `pnpm install` å®‰è£…ä¾èµ–ï¼›é¡¹ç›®ä¸º ESM æ¨¡å¼ï¼ˆ`package.json` ä¸­ `type: "module"`ï¼‰ã€‚
- **ç±»å‹æ£€æŸ¥**ï¼šè¿è¡Œ `npx tsc --noEmit` è¿›è¡Œé™æ€æ£€æŸ¥ã€‚
- **æŒç»­æ„å»º**ï¼šæ‰§è¡Œ `pnpm run watch` è¿›å…¥ Vite watch æ¨¡å¼ï¼Œä¾¿äºè°ƒè¯•ã€‚
- **è°ƒè¯•æ—¥å¿—**ï¼šå°†é…ç½®é¡¹ `debug` è®¾ä¸º `true`ï¼Œå³å¯åœ¨ NapCat æ—¥å¿—ä¸­çœ‹åˆ°è¯¦ç»†è°ƒç”¨ä¿¡æ¯ã€‚
- **æ‰“åŒ…æ’é™¤**ï¼š`vite.config.ts` å°† Node å†…ç½®æ¨¡å—å£°æ˜ä¸º externalï¼Œç¡®ä¿æ‰“åŒ…äº§ç‰©ç²¾ç®€ä¸”è¿è¡Œæ—¶å¯ç”¨ã€‚

## æ•…éšœæ’æŸ¥

- **æµè§ˆå™¨æ— æ³•å¯åŠ¨**ï¼š
  1. æ£€æŸ¥æœ¬æœºæ˜¯å¦å®‰è£… Chrome/Edge/Chromiumï¼›
  2. åœ¨é…ç½®ä¸­æ‰‹åŠ¨å¡«å†™ `browser.executablePath`ï¼›
  3. Linux ç¯å¢ƒè‹¥ä»å¤±è´¥ï¼Œå¯å°è¯•åœ¨å¯åŠ¨å‚æ•°å¢åŠ  `--no-sandbox`ï¼ˆé»˜è®¤å·²æ·»åŠ ï¼‰ï¼›
  4. è€ƒè™‘ä½¿ç”¨ [Docker éƒ¨ç½²è¿œç¨‹æµè§ˆå™¨](#docker-éƒ¨ç½²è¿œç¨‹æµè§ˆå™¨æ¨è)ã€‚
- **è¿œç¨‹æµè§ˆå™¨è¿æ¥å¤±è´¥**ï¼š
  1. ç¡®è®¤æµè§ˆå™¨å®¹å™¨æ­£åœ¨è¿è¡Œï¼š`docker ps | grep chrome`ï¼›
  2. æ£€æŸ¥ WebSocket åœ°å€æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆåº”ä»¥ `ws://` å¼€å¤´ï¼‰ï¼›
  3. æµ‹è¯•ç«¯å£æ˜¯å¦å¯è¾¾ï¼š`curl http://<host>:<port>/json/version`ï¼›
  4. å¦‚æœ NapCat åœ¨ Docker ä¸­ï¼Œç¡®ä¿ä¸¤ä¸ªå®¹å™¨åœ¨åŒä¸€ç½‘ç»œæˆ–ç«¯å£å·²æ­£ç¡®æ˜ å°„ã€‚
- **æˆªå›¾ä¸ºç©ºç™½**ï¼š
  1. ç¡®è®¤ HTML æ¸²æŸ“åå­˜åœ¨ç›®æ ‡å…ƒç´ ï¼›
  2. è®¾ç½® `waitForSelector` æˆ– `waitForTimeout` ç­‰å¾…å‰ç«¯æ¸²æŸ“å®Œæˆï¼›
  3. å¦‚ä½¿ç”¨è¿œç¨‹å­—ä½“ï¼Œç¡®ä¿ç½‘ç»œå¯è¾¾ã€‚
- **ä¸­æ–‡ä¹±ç **ï¼š
  1. æœ¬åœ°æ¨¡å¼ï¼šåœ¨å®¿ä¸»ç³»ç»Ÿå®‰è£…ä¸­æ–‡å­—ä½“ï¼›
  2. Docker æ¨¡å¼ï¼šä½¿ç”¨åŒ…å«ä¸­æ–‡å­—ä½“çš„é•œåƒï¼Œæˆ–åœ¨æ¨¡æ¿ä¸­å¼•å…¥ Web å­—ä½“ï¼ˆå¦‚ Google Fontsï¼‰ã€‚
- **æ¸²æŸ“é˜»å¡**ï¼šè‹¥å¹¶å‘é‡å¤§ï¼Œè¯·è°ƒé«˜ `browser.maxPages` æˆ–è®¾è®¡é˜Ÿåˆ—ï¼Œé¿å…å¤§é‡ä»»åŠ¡åŒæ—¶æŠ¢å é¡µé¢ã€‚

## è®¸å¯è¯

MIT License Â© AQiaoYo
```
